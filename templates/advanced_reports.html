{% extends "base.html" %}

{% block title %}Advanced Reports - Client Engagement{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i data-feather="bar-chart-2" class="me-2"></i>Advanced Reports</h1>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="exportReport('pdf')">
                        <i data-feather="download" class="me-1"></i>Export PDF
                    </button>
                    <button class="btn btn-outline-primary" onclick="exportReport('excel')">
                        <i data-feather="file-text" class="me-1"></i>Export Excel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Controls -->
    <div class="card mb-4">
        <div class="card-header">
            <h5><i data-feather="filter" class="me-2"></i>Report Filters</h5>
        </div>
        <div class="card-body">
            <form method="GET" action="{{ url_for('manager.advanced_reports') }}">
                <div class="row">
                    <div class="col-md-3">
                        <label for="date_from" class="form-label">From Date</label>
                        <input type="month" class="form-control" name="date_from" id="date_from" 
                               value="{{ request.args.get('date_from', default_from_date) }}">
                    </div>
                    <div class="col-md-3">
                        <label for="date_to" class="form-label">To Date</label>
                        <input type="month" class="form-control" name="date_to" id="date_to" 
                               value="{{ request.args.get('date_to', default_to_date) }}">
                    </div>
                    <div class="col-md-3">
                        <label for="metric_filter" class="form-label">Focus Metric</label>
                        <select class="form-select" name="metric_filter" id="metric_filter">
                            <option value="">All Metrics</option>
                            {% for metric in metrics %}
                            <option value="{{ metric.id }}" 
                                {{ 'selected' if request.args.get('metric_filter') == metric.id|string }}>
                                {{ metric.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="client_filter" class="form-label">Compare Clients</label>
                        <select class="form-select" name="client_filter" id="client_filter" multiple>
                            {% for client in clients %}
                            <option value="{{ client.id }}" 
                                {{ 'selected' if client.id|string in request.args.getlist('client_filter') }}>
                                {{ client.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">
                            <i data-feather="search" class="me-1"></i>Generate Report
                        </button>
                        <a href="{{ url_for('manager.advanced_reports') }}" class="btn btn-outline-secondary">
                            <i data-feather="refresh-cw" class="me-1"></i>Reset Filters
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Executive Summary -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h4>{{ summary.total_clients }}</h4>
                    <p class="mb-0">Total Clients</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h4>{{ summary.avg_score }}%</h4>
                    <p class="mb-0">Average Score</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h4>{{ summary.improving_clients }}</h4>
                    <p class="mb-0">Improving Clients</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <h4>{{ summary.at_risk_clients }}</h4>
                    <p class="mb-0">At-Risk Clients</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Client Rankings by Metric -->
    <div class="card mb-4">
        <div class="card-header">
            <h5><i data-feather="award" class="me-2"></i>Client Rankings</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Client</th>
                            <th>Overall Score</th>
                            <th>Trend</th>
                            {% if metric_focus %}
                            <th>{{ metric_focus.name }}</th>
                            {% else %}
                            <th>Strongest Metric</th>
                            <th>Weakest Metric</th>
                            {% endif %}
                            <th>Action Required</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ranking in client_rankings %}
                        <tr>
                            <td>
                                <span class="badge bg-{{ ranking.rank_color }}">{{ ranking.rank }}</span>
                            </td>
                            <td>
                                <a href="{{ url_for('manager.client_details', client_id=ranking.client.id) }}" 
                                   class="text-decoration-none">
                                    {{ ranking.client.name }}
                                </a>
                            </td>
                            <td>
                                <div class="progress" style="width: 100px;">
                                    <div class="progress-bar bg-{{ ranking.score_color }}" 
                                         style="width: {{ ranking.score }}%">
                                        {{ ranking.score }}%
                                    </div>
                                </div>
                            </td>
                            <td>
                                {% if ranking.trend == 'up' %}
                                    <i data-feather="trending-up" class="text-success"></i> +{{ ranking.trend_value }}%
                                {% elif ranking.trend == 'down' %}
                                    <i data-feather="trending-down" class="text-danger"></i> {{ ranking.trend_value }}%
                                {% else %}
                                    <i data-feather="minus" class="text-secondary"></i> Stable
                                {% endif %}
                            </td>
                            {% if metric_focus %}
                            <td>{{ ranking.metric_score }}%</td>
                            {% else %}
                            <td class="text-success">{{ ranking.strongest_metric }}</td>
                            <td class="text-danger">{{ ranking.weakest_metric }}</td>
                            {% endif %}
                            <td>
                                <span class="badge bg-{{ ranking.action_color }}">
                                    {{ ranking.action_required }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Performance Trends Chart -->
    <div class="card mb-4">
        <div class="card-header">
            <h5><i data-feather="trending-up" class="me-2"></i>Performance Trends Comparison</h5>
        </div>
        <div class="card-body">
            <canvas id="performanceChart" width="400" height="150"></canvas>
        </div>
    </div>

    <!-- Metric Performance Matrix -->
    <div class="card mb-4">
        <div class="card-header">
            <h5><i data-feather="grid" class="me-2"></i>Metric Performance Matrix</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Metric</th>
                            <th>Weight</th>
                            <th>Industry Avg</th>
                            {% for client in selected_clients %}
                            <th>{{ client.name }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for metric_data in metric_matrix %}
                        <tr>
                            <td><strong>{{ metric_data.metric.name }}</strong></td>
                            <td>
                                <span class="badge bg-info">{{ metric_data.metric.weight }}/5</span>
                            </td>
                            <td>{{ metric_data.industry_avg }}%</td>
                            {% for score in metric_data.client_scores %}
                            <td>
                                <span class="badge bg-{{ score.color }}">{{ score.value }}%</span>
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Key Insights & Recommendations -->
    <div class="card">
        <div class="card-header">
            <h5><i data-feather="lightbulb" class="me-2"></i>Key Insights & Recommendations</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h6 class="text-success">Top Performers</h6>
                    <ul class="list-unstyled">
                        {% for insight in insights.top_performers %}
                        <li class="mb-2">
                            <i data-feather="check-circle" class="text-success me-1"></i>
                            <strong>{{ insight.client }}</strong>: {{ insight.description }}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6 class="text-warning">Areas for Improvement</h6>
                    <ul class="list-unstyled">
                        {% for insight in insights.improvements %}
                        <li class="mb-2">
                            <i data-feather="alert-triangle" class="text-warning me-1"></i>
                            <strong>{{ insight.client }}</strong>: {{ insight.description }}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Performance Trends Chart
const ctx = document.getElementById('performanceChart').getContext('2d');
const performanceChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: {{ chart_labels | safe }},
        datasets: {{ chart_datasets | safe }}
    },
    options: {
        responsive: true,
        interaction: {
            intersect: false,
            mode: 'index'
        },
        scales: {
            y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                    callback: function(value) {
                        return value + '%';
                    }
                }
            }
        },
        plugins: {
            legend: {
                position: 'top'
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.dataset.label + ': ' + context.parsed.y + '%';
                    }
                }
            }
        }
    }
});

function exportReport(format) {
    const url = new URL(window.location);
    url.searchParams.set('export', format);
    window.open(url.toString(), '_blank');
}
</script>
{% endblock %}