{% extends "base.html" %}

{% block title %}Scoresheet Entry - Accellis Client Engagement{% endblock %}

{% block extra_css %}
<style>
/* Fix dropdown positioning to prevent appearing on secondary screens */
.form-select {
    position: relative !important;
}

.form-select option {
    position: relative !important;
}

/* Ensure dropdowns stay within viewport */
select.form-select:focus {
    z-index: 1050;
    position: relative;
}

/* Force dropdown menus to stay within current screen bounds */
.dropdown-menu {
    position: absolute !important;
    will-change: transform;
    top: 0px;
    left: 0px;
    transform: translate3d(0px, 40px, 0px) !important;
    max-height: 300px;
    overflow-y: auto;
}

/* Ensure select dropdowns render correctly */
select {
    -webkit-appearance: menulist;
    -moz-appearance: menulist;
    appearance: menulist;
}

/* Additional positioning fixes for select elements */
.metric-select-container {
    position: relative;
    z-index: 1;
}

.metric-select-container select {
    position: relative;
    z-index: 2;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-clipboard-list me-2"></i>Complete Scoresheet Entry</h2>
                    <p class="text-muted">Enter all metric scores for a comprehensive client performance assessment</p>
                </div>
                <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Client Performance Scoresheet</h5>
                    <small class="text-muted">Complete all metrics for comprehensive performance tracking</small>
                </div>
                <div class="card-body">
                    <form method="POST" id="scoresheetForm">
                        <!-- Client Selection -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="client_id" class="form-label fw-bold">Client <span class="text-danger">*</span></label>
                                    <select class="form-select" id="client_id" name="client_id" required>
                                        <option value="">Select a client...</option>
                                        {% for client in clients %}
                                        <option value="{{ client.id }}">{{ client.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="scoresheet_date" class="form-label fw-bold">Assessment Date <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" id="scoresheet_date" name="scoresheet_date" 
                                           value="{{ today }}" required>
                                </div>
                            </div>
                        </div>

                        <!-- All Metrics Section -->
                        <div class="row">
                            <div class="col-12">
                                <h6 class="fw-bold mb-3">Performance Metrics Assessment</h6>
                                <div class="table-responsive">
                                    <table class="table table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="width: 25%;">Metric</th>
                                                <th style="width: 15%;">Weight</th>
                                                <th style="width: 20%;">Score (0-{{ max_points }})</th>
                                                <th style="width: 15%;">Weighted Points</th>
                                                <th style="width: 25%;">Notes</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for metric in metrics %}
                                            <tr>
                                                <td>
                                                    <strong>{{ metric.name }}</strong>
                                                    {% if metric.description %}
                                                    <small class="d-block text-muted">{{ metric.description }}</small>
                                                    {% endif %}
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge bg-secondary">{{ metric.weight }}</span>
                                                </td>
                                                <td>
                                                    {% if metric.input_type == 'select' %}
                                                        {% set max_option_value = metric.metric_options|selectattr('is_active')|map(attribute='option_value')|max %}
                                                        <select class="form-select metric-score" 
                                                                name="metric_{{ metric.id }}" 
                                                                id="metric_{{ metric.id }}"
                                                                data-weight="{{ metric.weight }}"
                                                                data-max="{{ max_option_value or 1 }}">
                                                            <option value="">Select...</option>
                                                            {% for option in metric.metric_options|sort(attribute='option_order') %}
                                                                {% if option.is_active %}
                                                                <option value="{{ option.option_value }}">{{ option.option_label }}</option>
                                                                {% endif %}
                                                            {% endfor %}
                                                        </select>
                                                    {% else %}
                                                        <input type="number" 
                                                               class="form-control metric-score" 
                                                               name="metric_{{ metric.id }}" 
                                                               id="metric_{{ metric.id }}"
                                                               min="0" 
                                                               max="{{ metric.max_score or 10 }}" 
                                                               step="0.1"
                                                               data-weight="{{ metric.weight }}"
                                                               data-max="{{ metric.max_score or 10 }}"
                                                               placeholder="{% if metric.name == 'Help Desk Usage' %}0.0-5.0 tickets/user/month{% else %}0-{{ metric.max_score or 10 }}{% endif %}">
                                                        {% if metric.name == 'Help Desk Usage' %}
                                                        <small class="text-muted">Tickets per end user per month (0.25-1.0 = optimal)</small>
                                                        {% endif %}
                                                    {% endif %}
                                                </td>
                                                <td class="text-center">
                                                    <span class="weighted-points fw-bold" id="weighted_{{ metric.id }}">0.0</span>
                                                </td>
                                                <td>
                                                    <textarea class="form-control" 
                                                              name="notes_{{ metric.id }}" 
                                                              rows="2" 
                                                              placeholder="Optional notes for {{ metric.name }}..."></textarea>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                        <tfoot class="table-dark">
                                            <tr>
                                                <th colspan="3" class="text-end">Total Scoresheet Points:</th>
                                                <th class="text-center">
                                                    <span id="totalPoints" class="fs-5">0.0</span> / {{ "%.0f"|format(max_possible_score) }}
                                                </th>
                                                <th></th>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Overall Notes Section -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label for="overall_notes" class="form-label fw-bold">Overall Assessment Notes</label>
                                    <textarea class="form-control" id="overall_notes" name="overall_notes" rows="4" 
                                              placeholder="Enter comprehensive notes about the client's overall performance, key strengths, areas for improvement, and any action items..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Save Options -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Draft scoresheets can be edited later. Final scoresheets are included in performance reports.
                                        </small>
                                    </div>
                                    <div class="btn-group">
                                        <button type="submit" name="save_type" value="draft" class="btn btn-outline-primary">
                                            <i class="fas fa-save me-1"></i>Save as Draft
                                        </button>
                                        <button type="submit" name="save_type" value="final" class="btn btn-success">
                                            <i class="fas fa-check-circle me-1"></i>Save as Final
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Scoring Guide -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Scoring Guide</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Performance Levels:</h6>
                            <ul class="list-unstyled">
                                <li><span class="badge bg-success me-2">Excellent</span>90-100% of maximum points</li>
                                <li><span class="badge bg-warning me-2">Good</span>70-89% of maximum points</li>
                                <li><span class="badge bg-danger me-2">Needs Improvement</span>Below 70% of maximum points</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>Maximum Scoresheet Total: {{ "%.0f"|format(max_possible_score) }} Points</h6>
                            <small class="text-muted">Each metric contributes differently based on its weight and maximum value. Current configuration allows up to {{ "%.0f"|format(max_possible_score) }} total points.</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Real-time calculation of weighted points and total
document.addEventListener('DOMContentLoaded', function() {
    const metricInputs = document.querySelectorAll('.metric-score');
    
    function calculateWeightedPoints() {
        let total = 0;
        
        metricInputs.forEach(input => {
            const score = parseFloat(input.value) || 0;
            const weight = parseFloat(input.dataset.weight) || 1;
            const maxValue = parseFloat(input.dataset.max) || 10;
            
            // Calculate weighted points
            const weightedPoints = (score / maxValue) * weight;
            total += weightedPoints;
            
            // Update the weighted points display
            const weightedSpan = document.getElementById('weighted_' + input.id.split('_')[1]);
            if (weightedSpan) {
                weightedSpan.textContent = weightedPoints.toFixed(1);
            }
        });
        
        // Update total
        document.getElementById('totalPoints').textContent = total.toFixed(1);
        
        // Update total color based on performance
        const totalElement = document.getElementById('totalPoints');
        const percentage = (total / {{ max_possible_score }}) * 100;
        
        totalElement.className = 'fs-5';
        if (percentage >= 90) {
            totalElement.classList.add('text-success');
        } else if (percentage >= 70) {
            totalElement.classList.add('text-warning');
        } else {
            totalElement.classList.add('text-danger');
        }
    }
    
    // Add event listeners to all metric inputs
    metricInputs.forEach(input => {
        input.addEventListener('input', calculateWeightedPoints);
    });
    
    // Initial calculation
    calculateWeightedPoints();
});
</script>
{% endblock %}